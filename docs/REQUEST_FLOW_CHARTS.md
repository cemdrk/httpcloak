# HTTPCloak Request Flow Charts

Comprehensive diagrams showing every step from session creation to response processing.

---

## Table of Contents
1. [Session Creation Flow](#1-session-creation-flow)
2. [HTTP/1.1 Request Flow](#2-http11-request-flow)
3. [HTTP/2 Request Flow](#3-http2-request-flow)
4. [HTTP/3 Request Flow](#4-http3-request-flow)
5. [LocalProxy Flow](#5-localproxy-flow)
6. [TLS Handshake Details](#6-tls-handshake-details)
7. [Header Processing](#7-header-processing)
8. [Cookie Flow](#8-cookie-flow)

---

## 1. Session Creation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SESSION CREATION FLOW                                │
└─────────────────────────────────────────────────────────────────────────────┘

Session("chrome-145", proxy="...", timeout=30)
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  1. CONFIG PARSING                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ • Generate session ID (16 bytes → 32 hex chars)                     │    │
│  │ • Parse preset name (default: "chrome-145")                         │    │
│  │ • Parse timeout (default: 30s)                                      │    │
│  │ • Parse proxy URL(s) - TCP, UDP, or unified                         │    │
│  │ • Parse ECH config domain (optional)                                │    │
│  │ • Parse HTTP version preference (auto/h1/h2/h3)                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  2. PRESET LOADING (fingerprint/presets.go)                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ fingerprint.Get("chrome-145") returns:                              │    │
│  │                                                                     │    │
│  │ ┌─────────────────────┐  ┌────────────────────────────────────┐    │    │
│  │ │ TLS Config          │  │ HTTP/2 Settings                    │    │    │
│  │ │ • ClientHelloID     │  │ • HEADER_TABLE_SIZE: 65536         │    │    │
│  │ │ • PSKClientHelloID  │  │ • ENABLE_PUSH: 0                   │    │    │
│  │ │ • QUICClientHelloID │  │ • INITIAL_WINDOW_SIZE: 6291456     │    │    │
│  │ │ • QUICPSKClientHello│  │ • MAX_HEADER_LIST_SIZE: 262144     │    │    │
│  │ └─────────────────────┘  │ • ConnectionWindowUpdate: 15663105 │    │    │
│  │                          └────────────────────────────────────┘    │    │
│  │ ┌─────────────────────┐  ┌────────────────────────────────────┐    │    │
│  │ │ Header Order        │  │ Platform Info                      │    │    │
│  │ │ • sec-ch-ua         │  │ • OS: Windows/macOS/Linux          │    │    │
│  │ │ • sec-ch-ua-mobile  │  │ • Arch: x86_64/arm64               │    │    │
│  │ │ • sec-ch-ua-platform│  │ • Platform Version                 │    │    │
│  │ │ • user-agent        │  │ • User-Agent string                │    │    │
│  │ │ • accept            │  └────────────────────────────────────┘    │    │
│  │ │ • sec-fetch-*       │                                            │    │
│  │ │ • accept-encoding   │                                            │    │
│  │ │ • accept-language   │                                            │    │
│  │ │ • priority          │                                            │    │
│  │ │ • cookie            │                                            │    │
│  │ └─────────────────────┘                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  3. TLS CONFIG SETUP                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      SHUFFLE SEED GENERATION                        │    │
│  │  ┌──────────────────────────────────────────────────────────────┐  │    │
│  │  │ shuffleSeed = rand.Uint64()  // Generated ONCE per session   │  │    │
│  │  │ Extensions shuffled deterministically with this seed         │  │    │
│  │  │ Same order for ALL connections in this session (Chrome-like) │  │    │
│  │  └──────────────────────────────────────────────────────────────┘  │    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ H1/H2 TLS Spec                 │ H3 QUIC TLS Spec           │   │    │
│  │  │ • UTLSIdToSpecWithSeed()       │ • UTLSIdToSpecWithSeed()   │   │    │
│  │  │ • Cache ClientHelloSpec        │ • Cache QUICClientHelloSpec│   │    │
│  │  │ • Cache PSKClientHelloSpec     │ • Cache QUICPSKSpec        │   │    │
│  │  │ • MinVersion: TLS 1.2          │ • MinVersion: TLS 1.3      │   │    │
│  │  │ • MaxVersion: TLS 1.3          │ • MaxVersion: TLS 1.3      │   │    │
│  │  │ • OmitEmptyPsk: true           │ • OmitEmptyPsk: true       │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  4. PROXY CONFIGURATION                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐         │    │
│  │  │ HTTP/HTTPS    │   │ SOCKS5        │   │ MASQUE        │         │    │
│  │  │ Proxy         │   │ Proxy         │   │ Proxy         │         │    │
│  │  ├───────────────┤   ├───────────────┤   ├───────────────┤         │    │
│  │  │ For: H1, H2   │   │ For: H1,H2,H3 │   │ For: H3 only  │         │    │
│  │  │ Method:       │   │ Method:       │   │ Method:       │         │    │
│  │  │ CONNECT       │   │ TCP CONNECT   │   │ CONNECT-UDP   │         │    │
│  │  │               │   │ UDP ASSOCIATE │   │ (HTTP/3)      │         │    │
│  │  │ TCPProxy ✓    │   │ TCPProxy ✓    │   │ UDPProxy ✓    │         │    │
│  │  │ UDPProxy ✗    │   │ UDPProxy ✓    │   │ TCPProxy ✗    │         │    │
│  │  └───────────────┘   └───────────────┘   └───────────────┘         │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  5. TRANSPORT INITIALIZATION                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐       │    │
│  │  │ HTTP/1.1        │ │ HTTP/2          │ │ HTTP/3          │       │    │
│  │  │ Transport       │ │ Transport       │ │ Transport       │       │    │
│  │  ├─────────────────┤ ├─────────────────┤ ├─────────────────┤       │    │
│  │  │ • Session cache │ │ • Session cache │ │ • Session cache │       │    │
│  │  │ • Max idle: 6   │ │ • Conn pool     │ │ • QUIC config   │       │    │
│  │  │ • Idle time:90s │ │ • Max age: 5min │ │ • UDP socket    │       │    │
│  │  │ • Connect: 30s  │ │ • Idle: 90s     │ │ • Idle: 30s     │       │    │
│  │  │ • Resp: 60s     │ │ • Ping: 15s     │ │ • Keepalive:15s │       │    │
│  │  │                 │ │                 │ │ • 0-RTT: true   │       │    │
│  │  └─────────────────┘ └─────────────────┘ └─────────────────┘       │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  6. SESSION STATE INITIALIZATION                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ • CookieJar: new empty jar                                          │    │
│  │ • DNS Cache: with TTL management                                    │    │
│  │ • Cache Entries: ETag/Last-Modified map                             │    │
│  │ • Client Hints: Accept-CH tracking map                              │    │
│  │ • CreatedAt: now                                                    │    │
│  │ • LastUsed: now                                                     │    │
│  │ • RequestCount: 0                                                   │    │
│  │ • Active: true                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
              ┌───────────┐
              │  SESSION  │
              │  READY    │
              └───────────┘
```

---

## 2. HTTP/1.1 Request Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         HTTP/1.1 REQUEST FLOW                                │
└─────────────────────────────────────────────────────────────────────────────┘

session.Get("https://example.com/path")
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  1. PRE-REQUEST SETUP                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ URL Parsing                                                         │    │
│  │ ┌─────────────────────────────────────────────────────────────┐    │    │
│  │ │ scheme: https  host: example.com  port: 443  path: /path    │    │    │
│  │ └─────────────────────────────────────────────────────────────┘    │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │ ┌─────────────────────────────────────────────────────────────┐    │    │
│  │ │ Cookie Retrieval from Jar                                   │    │    │
│  │ │ • Match domain (exact or .suffix)                           │    │    │
│  │ │ • Match path (prefix)                                       │    │    │
│  │ │ • Check secure flag                                         │    │    │
│  │ │ • Check expiration                                          │    │    │
│  │ │ → Cookie: session=abc123; user=john                         │    │    │
│  │ └─────────────────────────────────────────────────────────────┘    │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │ ┌─────────────────────────────────────────────────────────────┐    │    │
│  │ │ ECH Config (if enabled)                                     │    │    │
│  │ │ • Fetch from DNS HTTPS record                               │    │    │
│  │ │ • Or use provided ECHConfig bytes                           │    │    │
│  │ │ • Cache for session resumption                              │    │    │
│  │ └─────────────────────────────────────────────────────────────┘    │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │ ┌─────────────────────────────────────────────────────────────┐    │    │
│  │ │ DNS Resolution                                              │    │    │
│  │ │ • Check DNS cache                                           │    │    │
│  │ │ • If miss: resolve via system resolver                      │    │    │
│  │ │ • Sort: IPv4 preferred (if configured)                      │    │    │
│  │ │ • Cache with TTL                                            │    │    │
│  │ └─────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  2. CONNECTION ESTABLISHMENT                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Connection Pool Check                                       │   │    │
│  │  │ Key: "https://example.com:443"                              │   │    │
│  │  │ • Check idleConns map                                       │   │    │
│  │  │ • Verify not closed                                         │   │    │
│  │  │ • Verify lastUsed < 90s                                     │   │    │
│  │  └────────────────────────┬────────────────────────────────────┘   │    │
│  │                           │                                         │    │
│  │         ┌─────────────────┴─────────────────┐                      │    │
│  │         │                                   │                      │    │
│  │    [Found Healthy]                    [Not Found]                  │    │
│  │         │                                   │                      │    │
│  │         ▼                                   ▼                      │    │
│  │  ┌─────────────┐              ┌────────────────────────────┐      │    │
│  │  │ Reuse Conn  │              │ Create New Connection      │      │    │
│  │  └─────────────┘              │                            │      │    │
│  │         │                     │  ┌──────────────────────┐  │      │    │
│  │         │                     │  │ TCP Connect          │  │      │    │
│  │         │                     │  │ (direct or via proxy)│  │      │    │
│  │         │                     │  └──────────┬───────────┘  │      │    │
│  │         │                     │             │              │      │    │
│  │         │                     │             ▼              │      │    │
│  │         │                     │  ┌──────────────────────┐  │      │    │
│  │         │                     │  │ TLS Handshake        │  │      │    │
│  │         │                     │  │ (see section 6)      │  │      │    │
│  │         │                     │  └──────────┬───────────┘  │      │    │
│  │         │                     │             │              │      │    │
│  │         │                     └─────────────┼──────────────┘      │    │
│  │         │                                   │                      │    │
│  │         └───────────────────┬───────────────┘                      │    │
│  │                             │                                       │    │
│  │                             ▼                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ http1Conn ready                                             │   │    │
│  │  │ • TCP + TLS wrapped                                         │   │    │
│  │  │ • bufio.Reader (64KB)                                       │   │    │
│  │  │ • bufio.Writer (256KB)                                      │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  3. REQUEST BUILDING (HTTP/1.1 Wire Format)                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Request Line                                                │   │    │
│  │  │ GET /path HTTP/1.1\r\n                                      │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Headers (in HeaderOrder from preset)                        │   │    │
│  │  │                                                             │   │    │
│  │  │ Host: example.com\r\n                                       │   │    │
│  │  │ Connection: keep-alive\r\n                                  │   │    │
│  │  │ sec-ch-ua: "Chromium";v="143"...\r\n                        │   │    │
│  │  │ sec-ch-ua-mobile: ?0\r\n                                    │   │    │
│  │  │ sec-ch-ua-platform: "Windows"\r\n                           │   │    │
│  │  │ Upgrade-Insecure-Requests: 1\r\n                            │   │    │
│  │  │ User-Agent: Mozilla/5.0...\r\n                              │   │    │
│  │  │ Accept: text/html,application/xhtml+xml...\r\n              │   │    │
│  │  │ Sec-Fetch-Site: none\r\n                                    │   │    │
│  │  │ Sec-Fetch-Mode: navigate\r\n                                │   │    │
│  │  │ Sec-Fetch-User: ?1\r\n                                      │   │    │
│  │  │ Sec-Fetch-Dest: document\r\n                                │   │    │
│  │  │ Accept-Encoding: gzip, deflate, br, zstd\r\n                │   │    │
│  │  │ Accept-Language: en-US,en;q=0.9\r\n                         │   │    │
│  │  │ Cookie: session=abc123; user=john\r\n                       │   │    │
│  │  │ \r\n                                                        │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Body (if POST/PUT/PATCH)                                    │   │    │
│  │  │ [raw bytes or streamed from reader]                         │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Flush to wire                                               │   │    │
│  │  │ bw.Flush() → TCP socket → TLS encrypt → Network             │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  4. RESPONSE PROCESSING                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Read Status Line                                            │   │    │
│  │  │ HTTP/1.1 200 OK\r\n                                         │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Read Headers                                                │   │    │
│  │  │ • Line by line until \r\n\r\n                               │   │    │
│  │  │ • Parse name: value                                         │   │    │
│  │  │ • Extract Content-Length, Transfer-Encoding                 │   │    │
│  │  │ • Extract Set-Cookie headers                                │   │    │
│  │  │ • Extract Content-Encoding for decompression                │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Read Body                                                   │   │    │
│  │  │                                                             │   │    │
│  │  │ ┌────────────────┐  ┌────────────────┐  ┌──────────────┐   │   │    │
│  │  │ │ Content-Length │  │ Chunked        │  │ Until Close  │   │   │    │
│  │  │ │ Read N bytes   │  │ Read chunks    │  │ Read to EOF  │   │   │    │
│  │  │ └────────────────┘  │ until size=0   │  └──────────────┘   │   │    │
│  │  │                     └────────────────┘                      │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Decompress Body                                             │   │    │
│  │  │                                                             │   │    │
│  │  │ Content-Encoding │ Decoder                                  │   │    │
│  │  │ ─────────────────┼──────────────────                        │   │    │
│  │  │ gzip             │ gzip.NewReader                           │   │    │
│  │  │ br               │ brotli.NewReader                         │   │    │
│  │  │ zstd             │ zstd.NewReader                           │   │    │
│  │  │ deflate          │ flate.NewReader                          │   │    │
│  │  │ identity         │ (no decompression)                       │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Update Cookie Jar                                           │   │    │
│  │  │ • Parse Set-Cookie headers                                  │   │    │
│  │  │ • Extract domain, path, secure, httponly, expires           │   │    │
│  │  │ • Store/update in jar                                       │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Return Response                                             │   │    │
│  │  │ • StatusCode: 200                                           │   │    │
│  │  │ • Headers: map[string][]string                              │   │    │
│  │  │ • Body: decompressed bytes                                  │   │    │
│  │  │ • Protocol: "http/1.1"                                      │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. HTTP/2 Request Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          HTTP/2 REQUEST FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

session.Get("https://example.com/path")  [http_version="h2"]
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  1. PRE-REQUEST SETUP (same as HTTP/1.1)                                     │
│  • URL parsing, cookie retrieval, ECH config, DNS resolution                 │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  2. CONNECTION ESTABLISHMENT                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Connection Pool Check                                       │   │    │
│  │  │ Key: "example.com:443"                                      │   │    │
│  │  │ • Check conns map for existing h2Conn                       │   │    │
│  │  │ • Verify age < 5min, idle < 90s                             │   │    │
│  │  └────────────────────────┬────────────────────────────────────┘   │    │
│  │                           │                                         │    │
│  │         ┌─────────────────┴─────────────────┐                      │    │
│  │    [Found Healthy]                    [Not Found]                  │    │
│  │         │                                   │                      │    │
│  │         ▼                                   ▼                      │    │
│  │  ┌─────────────┐              ┌────────────────────────────┐      │    │
│  │  │ Reuse Conn  │              │ Create New Connection      │      │    │
│  │  └─────────────┘              └────────────┬───────────────┘      │    │
│  │         │                                  │                       │    │
│  │         │                     ┌────────────┴───────────────┐      │    │
│  │         │                     │ TCP + TLS with ALPN ["h2"] │      │    │
│  │         │                     └────────────┬───────────────┘      │    │
│  │         │                                  │                       │    │
│  │         │                     ┌────────────┴───────────────┐      │    │
│  │         │                     │ Check ALPN Result          │      │    │
│  │         │                     │ NegotiatedProtocol == "h2" │      │    │
│  │         │                     └────────────┬───────────────┘      │    │
│  │         │                                  │                       │    │
│  │         │                     ┌────────────┴───────────────┐      │    │
│  │         │                     │ HTTP/2 Connection Setup    │      │    │
│  │         │                     │                            │      │    │
│  │         │                     │ 1. Send Connection Preface │      │    │
│  │         │                     │    "PRI * HTTP/2.0\r\n     │      │    │
│  │         │                     │     \r\nSM\r\n\r\n"        │      │    │
│  │         │                     │                            │      │    │
│  │         │                     │ 2. Send SETTINGS frame     │      │    │
│  │         │                     │    ┌────────────────────┐  │      │    │
│  │         │                     │    │ HEADER_TABLE_SIZE: │  │      │    │
│  │         │                     │    │   65536            │  │      │    │
│  │         │                     │    │ ENABLE_PUSH: 0     │  │      │    │
│  │         │                     │    │ INITIAL_WINDOW:    │  │      │    │
│  │         │                     │    │   6291456          │  │      │    │
│  │         │                     │    │ MAX_HEADER_LIST:   │  │      │    │
│  │         │                     │    │   262144           │  │      │    │
│  │         │                     │    └────────────────────┘  │      │    │
│  │         │                     │                            │      │    │
│  │         │                     │ 3. Send WINDOW_UPDATE      │      │    │
│  │         │                     │    Increment: 15663105     │      │    │
│  │         │                     │    (Chrome connection flow)│      │    │
│  │         │                     │                            │      │    │
│  │         │                     │ 4. Wait for Server SETTINGS│      │    │
│  │         │                     │                            │      │    │
│  │         │                     │ 5. Send SETTINGS ACK       │      │    │
│  │         │                     └────────────┬───────────────┘      │    │
│  │         │                                  │                       │    │
│  │         └──────────────────────────────────┴───────────────┘      │    │
│  │                             │                                       │    │
│  │                             ▼                                       │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ h2Conn ready (multiplexed streams)                          │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  3. REQUEST BUILDING (HTTP/2 Frames)                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Allocate Stream ID (odd number: 1, 3, 5, ...)               │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Build Headers (PSEUDO HEADERS FIRST - PHeaderOrder)         │   │    │
│  │  │                                                             │   │    │
│  │  │ :method      = GET          ← Must be first                 │   │    │
│  │  │ :authority   = example.com  ← Second                        │   │    │
│  │  │ :scheme      = https        ← Third                         │   │    │
│  │  │ :path        = /path        ← Fourth                        │   │    │
│  │  │                                                             │   │    │
│  │  │ (Regular headers follow in HeaderOrder)                     │   │    │
│  │  │ sec-ch-ua: "Chromium";v="143"...                            │   │    │
│  │  │ sec-ch-ua-mobile: ?0                                        │   │    │
│  │  │ sec-ch-ua-platform: "Windows"                               │   │    │
│  │  │ upgrade-insecure-requests: 1                                │   │    │
│  │  │ user-agent: Mozilla/5.0...                                  │   │    │
│  │  │ accept: text/html...                                        │   │    │
│  │  │ sec-fetch-site: none                                        │   │    │
│  │  │ sec-fetch-mode: navigate                                    │   │    │
│  │  │ sec-fetch-user: ?1                                          │   │    │
│  │  │ sec-fetch-dest: document                                    │   │    │
│  │  │ accept-encoding: gzip, deflate, br, zstd                    │   │    │
│  │  │ accept-language: en-US,en;q=0.9                             │   │    │
│  │  │ priority: u=0, i                                            │   │    │
│  │  │ cookie: session=abc123                                      │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ HPACK Encoding                                              │   │    │
│  │  │                                                             │   │    │
│  │  │ ┌───────────────────────────────────────────────────────┐  │   │    │
│  │  │ │ Static Table (61 entries, never changes)              │  │   │    │
│  │  │ │ Index 2:  :method GET                                 │  │   │    │
│  │  │ │ Index 3:  :method POST                                │  │   │    │
│  │  │ │ Index 4:  :path /                                     │  │   │    │
│  │  │ │ Index 7:  :scheme https                               │  │   │    │
│  │  │ │ ...                                                   │  │   │    │
│  │  │ └───────────────────────────────────────────────────────┘  │   │    │
│  │  │ ┌───────────────────────────────────────────────────────┐  │   │    │
│  │  │ │ Dynamic Table (65536 bytes, built per connection)     │  │   │    │
│  │  │ │ Entry 62: :authority example.com                      │  │   │    │
│  │  │ │ Entry 63: user-agent Mozilla/5.0...                   │  │   │    │
│  │  │ │ ...                                                   │  │   │    │
│  │  │ └───────────────────────────────────────────────────────┘  │   │    │
│  │  │                                                             │   │    │
│  │  │ Encoding types:                                             │   │    │
│  │  │ • Indexed (1 byte): header in table                         │   │    │
│  │  │ • Literal + Index: add to dynamic table                     │   │    │
│  │  │ • Literal never index: sensitive headers                    │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ HEADERS Frame                                               │   │    │
│  │  │ ┌─────────────────────────────────────────────────────────┐│   │    │
│  │  ││ Length: [header block size]                              ││   │    │
│  │  ││ Type: 0x01 (HEADERS)                                     ││   │    │
│  │  ││ Flags: END_HEADERS (0x04) | END_STREAM (0x01 if no body) ││   │    │
│  │  ││ Stream ID: 1                                             ││   │    │
│  │  ││ Payload: [HPACK encoded headers]                         ││   │    │
│  │  │└─────────────────────────────────────────────────────────┘ │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ PRIORITY Frame (Chrome sends after HEADERS)                 │   │    │
│  │  │ ┌─────────────────────────────────────────────────────────┐│   │    │
│  │  ││ Type: 0x02 (PRIORITY)                                    ││   │    │
│  │  ││ Stream Dependency: 0                                     ││   │    │
│  │  ││ Exclusive: true                                          ││   │    │
│  │  ││ Weight: 255 (Chrome uses 256-1)                          ││   │    │
│  │  │└─────────────────────────────────────────────────────────┘ │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ DATA Frames (if body present)                               │   │    │
│  │  │ ┌─────────────────────────────────────────────────────────┐│   │    │
│  │  ││ Type: 0x00 (DATA)                                        ││   │    │
│  │  ││ Flags: END_STREAM (0x01 on last frame)                   ││   │    │
│  │  ││ Stream ID: 1                                             ││   │    │
│  │  ││ Payload: [body chunk, max 16384 bytes per frame]         ││   │    │
│  │  │└─────────────────────────────────────────────────────────┘ │   │    │
│  │  │ (multiple DATA frames if body > 16KB)                       │   │    │
│  │  │ (respect flow control: WINDOW_UPDATE)                       │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  4. RESPONSE PROCESSING                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Read HEADERS Frame (+ CONTINUATION if needed)               │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ HPACK Decode                                                │   │    │
│  │  │ • Decode pseudo headers (:status)                           │   │    │
│  │  │ • Decode regular headers                                    │   │    │
│  │  │ • Update dynamic table                                      │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Read DATA Frames until END_STREAM                           │   │    │
│  │  │ • Concatenate payloads                                      │   │    │
│  │  │ • Send WINDOW_UPDATE when buffer half consumed              │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Decompress, Update Cookies, Return Response                 │   │    │
│  │  │ (same as HTTP/1.1)                                          │   │    │
│  │  │ • Protocol: "h2"                                            │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. HTTP/3 Request Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          HTTP/3 REQUEST FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

session.Get("https://example.com/path")  [http_version="h3"]
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  1. PRE-REQUEST SETUP (same as HTTP/1.1)                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  2. QUIC CONNECTION ESTABLISHMENT                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ UDP Socket Setup                                            │   │    │
│  │  │                                                             │   │    │
│  │  │ ┌───────────────┐  ┌───────────────┐  ┌───────────────┐    │   │    │
│  │  │ │ Direct        │  │ SOCKS5 Proxy  │  │ MASQUE Proxy  │    │   │    │
│  │  │ │ net.ListenUDP │  │ UDP ASSOCIATE │  │ CONNECT-UDP   │    │   │    │
│  │  │ │ 0.0.0.0:0     │  │ relay address │  │ HTTP/3 tunnel │    │   │    │
│  │  │ └───────────────┘  └───────────────┘  └───────────────┘    │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ QUIC Initial Packet (Chrome-style)                          │   │    │
│  │  │                                                             │   │    │
│  │  │ ┌─────────────────────────────────────────────────────────┐│   │    │
│  │  ││ Long Header Format:                                      ││   │    │
│  │  ││ ├─ Flags: 0xC0 (Long header, Initial packet)             ││   │    │
│  │  ││ ├─ Version: 0x00000001 (QUIC v1)                         ││   │    │
│  │  ││ ├─ DCID Length: 8 bytes                                  ││   │    │
│  │  ││ ├─ DCID: [random 8 bytes]                                ││   │    │
│  │  ││ ├─ SCID Length: 0                                        ││   │    │
│  │  ││ ├─ Token Length: 0                                       ││   │    │
│  │  ││ └─ Packet Number + Payload                               ││   │    │
│  │  │└─────────────────────────────────────────────────────────┘ │   │    │
│  │  │                                                             │   │    │
│  │  │ Initial Packet Size: 1250 bytes (Chrome-like)               │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ CRYPTO Frame (TLS ClientHello embedded in QUIC)             │   │    │
│  │  │                                                             │   │    │
│  │  │ Transport Parameters (Chrome order + shuffle):              │   │    │
│  │  │ ┌─────────────────────────────────────────────────────────┐│   │    │
│  │  ││ • max_idle_timeout: 30000 (30s)                          ││   │    │
│  │  ││ • initial_max_data: 15728640                             ││   │    │
│  │  ││ • initial_max_stream_data_bidi_local: 6291456            ││   │    │
│  │  ││ • initial_max_stream_data_bidi_remote: 6291456           ││   │    │
│  │  ││ • initial_max_stream_data_uni: 6291456                   ││   │    │
│  │  ││ • initial_max_streams_bidi: 100                          ││   │    │
│  │  ││ • initial_max_streams_uni: 103                           ││   │    │
│  │  ││ • max_datagram_frame_size: 65536                         ││   │    │
│  │  ││ • version_information (0x11):                            ││   │    │
│  │  ││     chosen: QUICv1                                       ││   │    │
│  │  ││     available: [GREASE, QUICv1]                          ││   │    │
│  │  ││ • google_version (0x4752): QUICv1                        ││   │    │
│  │  │└─────────────────────────────────────────────────────────┘ │   │    │
│  │  │                                                             │   │    │
│  │  │ TLS Extensions (same as H2, shuffled with seed):            │   │    │
│  │  │ • server_name (with ECH if enabled)                         │   │    │
│  │  │ • supported_versions, key_share, etc.                       │   │    │
│  │  │ • quic_transport_parameters (QUIC-specific)                 │   │    │
│  │  │ • ALPN: ["h3"]                                              │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │            ┌─────────────────┴─────────────────┐                   │    │
│  │            │                                   │                   │    │
│  │      [Session Exists]                    [New Session]             │    │
│  │            │                                   │                   │    │
│  │            ▼                                   ▼                   │    │
│  │  ┌─────────────────┐              ┌─────────────────────┐         │    │
│  │  │ 0-RTT Early Data│              │ 1-RTT Full Handshake│         │    │
│  │  │ DialEarly()     │              │ Dial()              │         │    │
│  │  │ Send request    │              │ Wait for ServerHello│         │    │
│  │  │ with 0-RTT      │              │ Complete handshake  │         │    │
│  │  └─────────────────┘              └─────────────────────┘         │    │
│  │            │                                   │                   │    │
│  │            └─────────────────┬─────────────────┘                   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ HTTP/3 Control Stream Setup                                 │   │    │
│  │  │                                                             │   │    │
│  │  │ Send SETTINGS Frame:                                        │   │    │
│  │  │ ┌─────────────────────────────────────────────────────────┐│   │    │
│  │  ││ QPACK_MAX_TABLE_CAPACITY (0x01): 65536                   ││   │    │
│  │  ││ QPACK_BLOCKED_STREAMS (0x07): 100                        ││   │    │
│  │  ││ GREASE_SETTING (0x1f*N+0x21): random non-zero            ││   │    │
│  │  │└─────────────────────────────────────────────────────────┘ │   │    │
│  │  │                                                             │   │    │
│  │  │ Send GREASE Frames (random frame types)                     │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  3. REQUEST BUILDING (HTTP/3 Frames over QUIC)                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Open Bidirectional Stream (client-initiated)                │   │    │
│  │  │ Stream ID: 0, 4, 8, ... (client bidi = 4n)                  │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Build Headers (same order as HTTP/2)                        │   │    │
│  │  │                                                             │   │    │
│  │  │ Pseudo Headers (PHeaderOrder):                              │   │    │
│  │  │ :method      = GET                                          │   │    │
│  │  │ :authority   = example.com                                  │   │    │
│  │  │ :scheme      = https                                        │   │    │
│  │  │ :path        = /path                                        │   │    │
│  │  │                                                             │   │    │
│  │  │ Regular Headers (HeaderOrder):                              │   │    │
│  │  │ (same as HTTP/2)                                            │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ QPACK Encoding                                              │   │    │
│  │  │                                                             │   │    │
│  │  │ ┌───────────────────────────────────────────────────────┐  │   │    │
│  │  │ │ QPACK vs HPACK Differences:                           │  │   │    │
│  │  │ │                                                       │  │   │    │
│  │  │ │ HPACK:                    QPACK:                      │  │   │    │
│  │  │ │ • Table updates inline    • Table updates on separate │  │   │    │
│  │  │ │ • Blocking on decode      • encoder stream            │  │   │    │
│  │  │ │                           • Can reference unacked     │  │   │    │
│  │  │ │                           • Tracks blocked streams    │  │   │    │
│  │  │ └───────────────────────────────────────────────────────┘  │   │    │
│  │  │                                                             │   │    │
│  │  │ Encoder Stream (unidirectional stream for table updates):   │   │    │
│  │  │ • Insert with name reference                                │   │    │
│  │  │ • Insert with literal name                                  │   │    │
│  │  │ • Duplicate                                                 │   │    │
│  │  │ • Set dynamic table capacity                                │   │    │
│  │  │                                                             │   │    │
│  │  │ Static Table: Same 99 entries as HPACK + more               │   │    │
│  │  │ Dynamic Table: 65536 bytes (QPACK_MAX_TABLE_CAPACITY)       │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ HEADERS Frame (on request stream)                           │   │    │
│  │  │ ┌─────────────────────────────────────────────────────────┐│   │    │
│  │  ││ Frame Type: 0x01 (HEADERS)                               ││   │    │
│  │  ││ Length: [variable]                                       ││   │    │
│  │  ││ Payload:                                                 ││   │    │
│  │  ││ ├─ Required Insert Count (for dynamic table refs)        ││   │    │
│  │  ││ ├─ Base (dynamic table index offset)                     ││   │    │
│  │  ││ └─ Compressed Header Block (QPACK encoded)               ││   │    │
│  │  │└─────────────────────────────────────────────────────────┘ │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ DATA Frames (if body present)                               │   │    │
│  │  │ ┌─────────────────────────────────────────────────────────┐│   │    │
│  │  ││ Frame Type: 0x00 (DATA)                                  ││   │    │
│  │  ││ Length: [variable]                                       ││   │    │
│  │  ││ Payload: [body bytes]                                    ││   │    │
│  │  │└─────────────────────────────────────────────────────────┘ │   │    │
│  │  │                                                             │   │    │
│  │  │ Flow Control:                                               │   │    │
│  │  │ • Stream-level: MAX_STREAM_DATA frame                       │   │    │
│  │  │ • Connection-level: MAX_DATA frame                          │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Send FIN on stream (signals end of request)                 │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  4. RESPONSE PROCESSING                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Read HEADERS Frame from response stream                     │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ QPACK Decode                                                │   │    │
│  │  │ • Read Required Insert Count, Base                          │   │    │
│  │  │ • If references unacked entries: block (up to 100 streams)  │   │    │
│  │  │ • Decode header fields                                      │   │    │
│  │  │ • Send decoder acknowledgment on decoder stream             │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Read DATA Frames until stream FIN                           │   │    │
│  │  │ • Send MAX_STREAM_DATA to increase window                   │   │    │
│  │  │ • Send MAX_DATA for connection window                       │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Decompress, Update Cookies, Return Response                 │   │    │
│  │  │ (same as HTTP/1.1)                                          │   │    │
│  │  │ • Protocol: "h3"                                            │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. LocalProxy Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LOCALPROXY FLOW                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────┐
                    │         CLIENT APPLICATION          │
                    │    (Browser, HttpClient, curl)      │
                    └─────────────────┬───────────────────┘
                                      │
                                      │ HTTP/HTTPS Request
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      LOCAL PROXY (127.0.0.1:8080)                            │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Accept TCP Connection                                       │   │    │
│  │  │ • Listen on 127.0.0.1:{port}                                │   │    │
│  │  │ • Increment activeConns                                     │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ Read Request                                                │   │    │
│  │  │ • Parse method, URL, headers (max 100KB)                    │   │    │
│  │  │ • Detect request type                                       │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                              │                                      │    │
│  │              ┌───────────────┴───────────────┐                     │    │
│  │              │                               │                     │    │
│  │     [HTTP Request]                  [CONNECT Request]              │    │
│  │     GET http://...                  CONNECT host:443               │    │
│  │              │                               │                     │    │
│  │              ▼                               ▼                     │    │
│  └──────────────┼───────────────────────────────┼──────────────────────┘    │
│                 │                               │                           │
└─────────────────┼───────────────────────────────┼───────────────────────────┘
                  │                               │
                  ▼                               ▼
┌─────────────────────────────────┐  ┌─────────────────────────────────────┐
│  HTTP REQUEST HANDLING          │  │  HTTPS CONNECT HANDLING              │
│                                 │  │                                      │
│ ┌─────────────────────────────┐ │  │ ┌──────────────────────────────────┐│
│ │ Parse Special Headers       │ │  │ │ Extract Host:Port                ││
│ │                             │ │  │ │ CONNECT example.com:443          ││
│ │ X-HTTPCloak-Session:        │ │  │ └──────────────────────────────────┘│
│ │   → Route to specific       │ │  │                  │                  │
│ │     session                 │ │  │                  ▼                  │
│ │                             │ │  │ ┌──────────────────────────────────┐│
│ │ X-Upstream-Proxy:           │ │  │ │ Check Proxy-Authorization       ││
│ │   → Use specified proxy     │ │  │ │                                  ││
│ │                             │ │  │ │ "HTTPCloak http://proxy:8080"   ││
│ │ X-HTTPCloak-TlsOnly:        │ │  │ │   → Use upstream proxy          ││
│ │   → TLS fingerprint only    │ │  │ └──────────────────────────────────┘│
│ │                             │ │  │                  │                  │
│ │ X-HTTPCloak-Scheme:         │ │  │                  ▼                  │
│ │   → Upgrade to HTTPS        │ │  │ ┌──────────────────────────────────┐│
│ └─────────────────────────────┘ │  │ │ Connect to Target                ││
│              │                  │  │ │ (via session or direct)          ││
│              ▼                  │  │ └──────────────────────────────────┘│
│ ┌─────────────────────────────┐ │  │                  │                  │
│ │ Session Routing             │ │  │                  ▼                  │
│ │                             │ │  │ ┌──────────────────────────────────┐│
│ │ ┌─────────────────────────┐ │ │  │ │ Send "200 Connection Established"││
│ │ │ Session Registry        │ │ │  │ │ HTTP/1.1 200 Connection          ││
│ │ │ ┌───────────────────┐   │ │ │  │ │ Established\r\n\r\n              ││
│ │ │ │ sessionID → Session│   │ │ │  │ └──────────────────────────────────┘│
│ │ │ │ "user1" → Session1 │   │ │ │  │                  │                  │
│ │ │ │ "user2" → Session2 │   │ │ │  │                  ▼                  │
│ │ │ └───────────────────┘   │ │ │  │ ┌──────────────────────────────────┐│
│ │ └─────────────────────────┘ │ │  │ │ Bidirectional Tunnel             ││
│ │                             │ │  │ │                                  ││
│ │ X-HTTPCloak-Session header  │ │  │ │  Client ←──────→ Target          ││
│ │ → Look up session           │ │  │ │                                  ││
│ │ → Use that session's        │ │  │ │  (TLS handshake done by client) ││
│ │   fingerprint               │ │  │ │  (NO fingerprinting by proxy)   ││
│ └─────────────────────────────┘ │  │ │                                  ││
│              │                  │  │ │  Copy until EOF:                 ││
│              ▼                  │  │ │  • Client → Target               ││
│ ┌─────────────────────────────┐ │  │ │  • Target → Client               ││
│ │ Execute via Session         │ │  │ └──────────────────────────────────┘│
│ │                             │ │  │                  │                  │
│ │ session.DoStream(req)       │ │  │                  ▼                  │
│ │ • Apply preset headers      │ │  │ ┌──────────────────────────────────┐│
│ │ • Apply TLS fingerprint     │ │  │ │ Close when done                  ││
│ │ • Route through proxy       │ │  │ │ • Wait for EOF from both sides   ││
│ │ • Manage cookies            │ │  │ │ • Close TCP connection           ││
│ └─────────────────────────────┘ │  │ └──────────────────────────────────┘│
│              │                  │  │                                      │
│              ▼                  │  └──────────────────────────────────────┘
│ ┌─────────────────────────────┐ │
│ │ Stream Response Back        │ │
│ │                             │ │
│ │ • Forward status line       │ │
│ │ • Forward headers           │ │
│ │ • Stream body chunks        │ │
│ │ • Handle chunked encoding   │ │
│ └─────────────────────────────┘ │
│              │                  │
└──────────────┼──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│ Connection Keep-Alive Check     │
│                                 │
│ Connection: keep-alive          │
│   → Keep socket open            │
│   → Wait for next request       │
│                                 │
│ Connection: close               │
│   → Close socket                │
│   → Decrement activeConns       │
└─────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                     LOCALPROXY SESSION REGISTRY                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  Register Session:                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ proxy.RegisterSession("user1", session1)                    │   │    │
│  │  │ proxy.RegisterSession("user2", session2)                    │   │    │
│  │  │ proxy.RegisterSession("account-a", sessionA)                │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  │  Client Request with Session Header:                                │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ GET http://api.example.com/data HTTP/1.1                    │   │    │
│  │  │ X-HTTPCloak-Session: user1                                  │   │    │
│  │  │                                                             │   │    │
│  │  │ → Routes to session1 (user1's cookies, proxy, fingerprint)  │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  │  Use Cases:                                                         │    │
│  │  • Different proxies per user/account                               │    │
│  │  • Different browser fingerprints per session                       │    │
│  │  • Separate cookie jars per session                                 │    │
│  │  • Multi-account management                                         │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. TLS Handshake Details

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        TLS 1.3 HANDSHAKE FLOW                                │
└─────────────────────────────────────────────────────────────────────────────┘

CLIENT                                                              SERVER
   │                                                                   │
   │  ┌─────────────────────────────────────────────────────────────┐ │
   │  │                    ClientHello                               │ │
   │  │                                                              │ │
   │  │  ┌────────────────────────────────────────────────────────┐ │ │
   │  │  │ Protocol Version: TLS 1.2 (for compat, actual in ext)  │ │ │
   │  │  │ Random: 32 bytes                                       │ │ │
   │  │  │ Session ID: 32 bytes (or 0 for new)                    │ │ │
   │  │  │ Cipher Suites (Chrome 143 order):                      │ │ │
   │  │  │   • TLS_AES_128_GCM_SHA256                             │ │ │
   │  │  │   • TLS_AES_256_GCM_SHA384                             │ │ │
   │  │  │   • TLS_CHACHA20_POLY1305_SHA256                       │ │ │
   │  │  │   • TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256            │ │ │
   │  │  │   • TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256              │ │ │
   │  │  │   • ... (15 total)                                     │ │ │
   │  │  │ Compression Methods: [null]                            │ │ │
   │  │  └────────────────────────────────────────────────────────┘ │ │
   │  │                                                              │ │
   │  │  ┌────────────────────────────────────────────────────────┐ │ │
   │  │  │ Extensions (SHUFFLED with session seed):               │ │ │
   │  │  │                                                        │ │ │
   │  │  │ ┌──────────────────────────────────────────────────┐  │ │ │
   │  │  │ │ server_name (SNI)                                │  │ │ │
   │  │  │ │ • If ECH: public_name from ECH config            │  │ │ │
   │  │  │ │ • Else: actual target hostname                   │  │ │ │
   │  │  │ └──────────────────────────────────────────────────┘  │ │ │
   │  │  │                                                        │ │ │
   │  │  │ ┌──────────────────────────────────────────────────┐  │ │ │
   │  │  │ │ supported_groups (Chrome 143):                   │  │ │ │
   │  │  │ │ • X25519Kyber768Draft00 (PQC)                    │  │ │ │
   │  │  │ │ • X25519                                         │  │ │ │
   │  │  │ │ • secp256r1                                      │  │ │ │
   │  │  │ │ • secp384r1                                      │  │ │ │
   │  │  │ └──────────────────────────────────────────────────┘  │ │ │
   │  │  │                                                        │ │ │
   │  │  │ ┌──────────────────────────────────────────────────┐  │ │ │
   │  │  │ │ key_share:                                       │  │ │ │
   │  │  │ │ • X25519Kyber768Draft00: 1120 bytes              │  │ │ │
   │  │  │ │ • X25519: 32 bytes                               │  │ │ │
   │  │  │ └──────────────────────────────────────────────────┘  │ │ │
   │  │  │                                                        │ │ │
   │  │  │ ┌──────────────────────────────────────────────────┐  │ │ │
   │  │  │ │ supported_versions: [TLS 1.3, TLS 1.2]           │  │ │ │
   │  │  │ └──────────────────────────────────────────────────┘  │ │ │
   │  │  │                                                        │ │ │
   │  │  │ ┌──────────────────────────────────────────────────┐  │ │ │
   │  │  │ │ signature_algorithms:                            │  │ │ │
   │  │  │ │ • ecdsa_secp256r1_sha256                         │  │ │ │
   │  │  │ │ • rsa_pss_rsae_sha256                            │  │ │ │
   │  │  │ │ • rsa_pkcs1_sha256                               │  │ │ │
   │  │  │ │ • ... (13 total)                                 │  │ │ │
   │  │  │ └──────────────────────────────────────────────────┘  │ │ │
   │  │  │                                                        │ │ │
   │  │  │ ┌──────────────────────────────────────────────────┐  │ │ │
   │  │  │ │ psk_key_exchange_modes: [psk_dhe_ke]             │  │ │ │
   │  │  │ └──────────────────────────────────────────────────┘  │ │ │
   │  │  │                                                        │ │ │
   │  │  │ ┌──────────────────────────────────────────────────┐  │ │ │
   │  │  │ │ application_layer_protocol_negotiation (ALPN):   │  │ │ │
   │  │  │ │ • "h2" (HTTP/2) or "h3" (HTTP/3)                 │  │ │ │
   │  │  │ └──────────────────────────────────────────────────┘  │ │ │
   │  │  │                                                        │ │ │
   │  │  │ ┌──────────────────────────────────────────────────┐  │ │ │
   │  │  │ │ compress_certificate: [brotli]                   │  │ │ │
   │  │  │ └──────────────────────────────────────────────────┘  │ │ │
   │  │  │                                                        │ │ │
   │  │  │ ┌──────────────────────────────────────────────────┐  │ │ │
   │  │  │ │ encrypted_client_hello (IF ECH enabled):         │  │ │ │
   │  │  │ │ • Cipher suite                                   │  │ │ │
   │  │  │ │ • Config ID                                      │  │ │ │
   │  │  │ │ • Enc (HPKE encapsulated key)                    │  │ │ │
   │  │  │ │ • Payload (encrypted inner ClientHello)          │  │ │ │
   │  │  │ └──────────────────────────────────────────────────┘  │ │ │
   │  │  │                                                        │ │ │
   │  │  │ ┌──────────────────────────────────────────────────┐  │ │ │
   │  │  │ │ pre_shared_key (IF resuming, MUST BE LAST):      │  │ │ │
   │  │  │ │ • PSK identity (session ticket)                  │  │ │ │
   │  │  │ │ • Obfuscated ticket age                          │  │ │ │
   │  │  │ │ • PSK binder (HMAC of transcript)                │  │ │ │
   │  │  │ └──────────────────────────────────────────────────┘  │ │ │
   │  │  │                                                        │ │ │
   │  │  │ Other extensions (shuffled):                           │ │ │
   │  │  │ • extended_master_secret                               │ │ │
   │  │  │ • renegotiation_info                                   │ │ │
   │  │  │ • ec_point_formats                                     │ │ │
   │  │  │ • session_ticket                                       │ │ │
   │  │  │ • status_request (OCSP)                                │ │ │
   │  │  │ • signed_certificate_timestamp                         │ │ │
   │  │  │ • application_settings (ALPS)                          │ │ │
   │  │  │ • GREASE values (random, ignored by server)            │ │ │
   │  │  └────────────────────────────────────────────────────────┘ │ │
   │  └──────────────────────────────────────────────────────────────┘ │
   │──────────────────────────────────────────────────────────────────→│
   │                                                                   │
   │                                                                   │
   │  ┌─────────────────────────────────────────────────────────────┐ │
   │  │                    ServerHello                               │ │
   │  │  • Selected cipher suite                                     │ │
   │  │  • Selected key share                                        │ │
   │  │  • Random                                                    │ │
   │  │  • supported_versions: TLS 1.3                               │ │
   │  │  • (encrypted_client_hello response if ECH used)             │ │
   │  └─────────────────────────────────────────────────────────────┘ │
   │←──────────────────────────────────────────────────────────────────│
   │                                                                   │
   │  ┌─────────────────────────────────────────────────────────────┐ │
   │  │              {EncryptedExtensions}                           │ │
   │  │  • ALPN result (h2 or h3)                                    │ │
   │  │  • early_data (if 0-RTT accepted)                            │ │
   │  └─────────────────────────────────────────────────────────────┘ │
   │←──────────────────────────────────────────────────────────────────│
   │                                                                   │
   │  ┌─────────────────────────────────────────────────────────────┐ │
   │  │   {Certificate} (skipped if PSK resumption)                  │ │
   │  │  • Certificate chain                                         │ │
   │  │  • (may be compressed with brotli)                           │ │
   │  └─────────────────────────────────────────────────────────────┘ │
   │←──────────────────────────────────────────────────────────────────│
   │                                                                   │
   │  ┌─────────────────────────────────────────────────────────────┐ │
   │  │   {CertificateVerify}                                        │ │
   │  │  • Signature over handshake transcript                       │ │
   │  └─────────────────────────────────────────────────────────────┘ │
   │←──────────────────────────────────────────────────────────────────│
   │                                                                   │
   │  ┌─────────────────────────────────────────────────────────────┐ │
   │  │   {Finished}                                                 │ │
   │  │  • HMAC over handshake transcript                            │ │
   │  └─────────────────────────────────────────────────────────────┘ │
   │←──────────────────────────────────────────────────────────────────│
   │                                                                   │
   │                                                                   │
   │  ┌─────────────────────────────────────────────────────────────┐ │
   │  │   {Finished}                                                 │ │
   │  │  • Client's HMAC over handshake transcript                   │ │
   │  └─────────────────────────────────────────────────────────────┘ │
   │──────────────────────────────────────────────────────────────────→│
   │                                                                   │
   │                    ═══════════════════════                        │
   │                    HANDSHAKE COMPLETE                             │
   │                    Application Data Ready                         │
   │                    ═══════════════════════                        │
   │                                                                   │
   │  ┌─────────────────────────────────────────────────────────────┐ │
   │  │   [NewSessionTicket] (for future resumption)                 │ │
   │  │  • Ticket lifetime                                           │ │
   │  │  • Ticket age add (obfuscation)                              │ │
   │  │  • Ticket nonce                                              │ │
   │  │  • Ticket (encrypted session state)                          │ │
   │  │  • Extensions (early_data max size)                          │ │
   │  └─────────────────────────────────────────────────────────────┘ │
   │←──────────────────────────────────────────────────────────────────│
   │                                                                   │
   │  Store ticket in session cache for future 0-RTT/resumption       │
   │                                                                   │


┌─────────────────────────────────────────────────────────────────────────────┐
│                    ECH (Encrypted Client Hello) DETAIL                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  WITHOUT ECH:                         WITH ECH:                     │    │
│  │  ┌─────────────────────┐              ┌─────────────────────┐      │    │
│  │  │ ClientHello         │              │ Outer ClientHello   │      │    │
│  │  │ SNI: target.com     │              │ SNI: cloudflare.com │      │    │
│  │  │ (visible to ISP)    │              │ (public ECH name)   │      │    │
│  │  └─────────────────────┘              │                     │      │    │
│  │                                       │ encrypted_client_   │      │    │
│  │                                       │ hello extension:    │      │    │
│  │                                       │ ┌─────────────────┐ │      │    │
│  │                                       │ │ Inner ClientHello│ │      │    │
│  │                                       │ │ SNI: target.com  │ │      │    │
│  │                                       │ │ (encrypted)      │ │      │    │
│  │                                       │ └─────────────────┘ │      │    │
│  │                                       └─────────────────────┘      │    │
│  │                                                                     │    │
│  │  ECH Config (from DNS HTTPS record):                                │    │
│  │  • public_name: cloudflare-ech.com                                  │    │
│  │  • public_key: [HPKE public key]                                    │    │
│  │  • kem_id, kdf_id, aead_id: crypto algorithms                       │    │
│  │  • maximum_name_length: padding size                                │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Header Processing

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        HEADER PROCESSING FLOW                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  REQUEST HEADER CONSTRUCTION                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  1. Start with preset headers (fingerprint/presets.go)              │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ preset.Headers = map[string]string{                     │    │    │
│  │     │   "Sec-Ch-Ua": "\"Chromium\";v=\"143\"...",             │    │    │
│  │     │   "Sec-Ch-Ua-Mobile": "?0",                             │    │    │
│  │     │   "Sec-Ch-Ua-Platform": "\"Windows\"",                  │    │    │
│  │     │   "User-Agent": "Mozilla/5.0...",                       │    │    │
│  │     │   "Accept": "text/html,application/xhtml+xml...",       │    │    │
│  │     │   "Accept-Encoding": "gzip, deflate, br, zstd",         │    │    │
│  │     │   "Accept-Language": "en-US,en;q=0.9",                  │    │    │
│  │     │ }                                                       │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  2. Apply Sec-Fetch headers based on mode (client/client.go)        │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ FetchMode = Navigate (human click):                     │    │    │
│  │     │   Sec-Fetch-Site: none | same-origin | same-site | cross│    │    │
│  │     │   Sec-Fetch-Mode: navigate                              │    │    │
│  │     │   Sec-Fetch-User: ?1                                    │    │    │
│  │     │   Sec-Fetch-Dest: document                              │    │    │
│  │     │   Upgrade-Insecure-Requests: 1                          │    │    │
│  │     │                                                         │    │    │
│  │     │ FetchMode = CORS (XHR/fetch):                           │    │    │
│  │     │   Sec-Fetch-Site: same-origin | same-site | cross-site  │    │    │
│  │     │   Sec-Fetch-Mode: cors                                  │    │    │
│  │     │   Sec-Fetch-Dest: empty                                 │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  3. Apply client hints if server requested (Accept-CH)              │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ If host in clientHints map:                             │    │    │
│  │     │   Sec-Ch-Ua-Arch: "x86"                                 │    │    │
│  │     │   Sec-Ch-Ua-Bitness: "64"                               │    │    │
│  │     │   Sec-Ch-Ua-Full-Version-List: full version info        │    │    │
│  │     │   Sec-Ch-Ua-Platform-Version: "15.0.0"                  │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  4. Add cookies from jar                                            │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ Cookie: session=abc123; user=john; pref=dark            │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  5. Add cache validation headers (if cached)                        │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ If-None-Match: "etag-value"                             │    │    │
│  │     │ If-Modified-Since: Wed, 21 Oct 2025 07:28:00 GMT        │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  6. Apply user custom headers (may override preset)                 │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ req.Headers = map[string]string{                        │    │    │
│  │     │   "Authorization": "Bearer token...",                   │    │    │
│  │     │   "X-Custom-Header": "value",                           │    │    │
│  │     │ }                                                       │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  7. Set header order (HeaderOrderKey)                               │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ Chrome 143 Header Order:                                │    │    │
│  │     │  1. sec-ch-ua                                           │    │    │
│  │     │  2. sec-ch-ua-mobile                                    │    │    │
│  │     │  3. sec-ch-ua-platform                                  │    │    │
│  │     │  4. upgrade-insecure-requests (if navigate)             │    │    │
│  │     │  5. user-agent                                          │    │    │
│  │     │  6. accept                                              │    │    │
│  │     │  7. sec-fetch-site                                      │    │    │
│  │     │  8. sec-fetch-mode                                      │    │    │
│  │     │  9. sec-fetch-user (if navigate)                        │    │    │
│  │     │ 10. sec-fetch-dest                                      │    │    │
│  │     │ 11. accept-encoding                                     │    │    │
│  │     │ 12. accept-language                                     │    │    │
│  │     │ 13. priority                                            │    │    │
│  │     │ 14. cookie (if present)                                 │    │    │
│  │     │ 15. [custom headers...]                                 │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                              │                                      │    │
│  │                              ▼                                      │    │
│  │  8. Set pseudo header order (PHeaderOrderKey) - H2/H3 only          │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ Pseudo Header Order (MUST be first, in this order):     │    │    │
│  │     │  1. :method                                             │    │    │
│  │     │  2. :authority                                          │    │    │
│  │     │  3. :scheme                                             │    │    │
│  │     │  4. :path                                               │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│  HPACK/QPACK COMPRESSION COMPARISON                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  ┌──────────────────────────┐  ┌──────────────────────────┐        │    │
│  │  │        HPACK (H2)        │  │        QPACK (H3)        │        │    │
│  │  ├──────────────────────────┤  ├──────────────────────────┤        │    │
│  │  │ • Static table: 61      │  │ • Static table: 99       │        │    │
│  │  │   entries               │  │   entries                │        │    │
│  │  │                          │  │                          │        │    │
│  │  │ • Dynamic table: per    │  │ • Dynamic table: per     │        │    │
│  │  │   connection            │  │   connection             │        │    │
│  │  │                          │  │                          │        │    │
│  │  │ • Table size: 65536     │  │ • Table size: 65536      │        │    │
│  │  │   (HEADER_TABLE_SIZE)   │  │   (QPACK_MAX_TABLE_CAP)  │        │    │
│  │  │                          │  │                          │        │    │
│  │  │ • Updates: inline with  │  │ • Updates: separate      │        │    │
│  │  │   headers               │  │   encoder stream         │        │    │
│  │  │                          │  │                          │        │    │
│  │  │ • Blocking: must decode │  │ • Blocking: can ref      │        │    │
│  │  │   in order              │  │   unacked entries        │        │    │
│  │  │                          │  │   (max 100 streams)      │        │    │
│  │  │                          │  │                          │        │    │
│  │  │ • Ack: implicit via     │  │ • Ack: explicit on       │        │    │
│  │  │   stream ordering       │  │   decoder stream         │        │    │
│  │  └──────────────────────────┘  └──────────────────────────┘        │    │
│  │                                                                     │    │
│  │  Static Table Examples (common entries):                            │    │
│  │  ┌────────────────────────────────────────────────────────────┐    │    │
│  │  │ Index │ Name              │ Value                         │    │    │
│  │  │───────┼───────────────────┼───────────────────────────────│    │    │
│  │  │   2   │ :method           │ GET                           │    │    │
│  │  │   3   │ :method           │ POST                          │    │    │
│  │  │   4   │ :path             │ /                             │    │    │
│  │  │   5   │ :path             │ /index.html                   │    │    │
│  │  │   7   │ :scheme           │ https                         │    │    │
│  │  │  15   │ accept-encoding   │ gzip, deflate                 │    │    │
│  │  │  16   │ accept-language   │                               │    │    │
│  │  │  19   │ content-type      │                               │    │    │
│  │  │  28   │ user-agent        │                               │    │    │
│  │  └────────────────────────────────────────────────────────────┘    │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Cookie Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           COOKIE FLOW                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  COOKIE JAR STRUCTURE                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  CookieJar {                                                        │    │
│  │    cookies: map[string][]CookieData {                               │    │
│  │                                                                     │    │
│  │      ".example.com": [                                              │    │
│  │        {                                                            │    │
│  │          Name: "session",                                           │    │
│  │          Value: "abc123",                                           │    │
│  │          Domain: ".example.com",                                    │    │
│  │          Path: "/",                                                 │    │
│  │          Secure: true,                                              │    │
│  │          HttpOnly: true,                                            │    │
│  │          Expires: 2026-01-24T12:00:00Z,                             │    │
│  │          SameSite: "Lax",                                           │    │
│  │        },                                                           │    │
│  │        {                                                            │    │
│  │          Name: "pref",                                              │    │
│  │          Value: "dark",                                             │    │
│  │          Domain: ".example.com",                                    │    │
│  │          Path: "/",                                                 │    │
│  │          ...                                                        │    │
│  │        },                                                           │    │
│  │      ],                                                             │    │
│  │                                                                     │    │
│  │      "api.example.com": [                                           │    │
│  │        {                                                            │    │
│  │          Name: "api_token",                                         │    │
│  │          Value: "xyz789",                                           │    │
│  │          Domain: "api.example.com",  // exact match only            │    │
│  │          ...                                                        │    │
│  │        },                                                           │    │
│  │      ],                                                             │    │
│  │    }                                                                │    │
│  │  }                                                                  │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│  REQUEST: COOKIE RETRIEVAL                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  Request URL: https://www.example.com/api/data                      │    │
│  │                                                                     │    │
│  │  1. Extract request info:                                           │    │
│  │     host: www.example.com                                           │    │
│  │     path: /api/data                                                 │    │
│  │     secure: true (https)                                            │    │
│  │                                                                     │    │
│  │  2. Domain matching:                                                │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ Cookie Domain      │ Request Host        │ Match?       │    │    │
│  │     │────────────────────┼─────────────────────┼──────────────│    │    │
│  │     │ .example.com       │ www.example.com     │ ✓ (suffix)   │    │    │
│  │     │ .example.com       │ api.example.com     │ ✓ (suffix)   │    │    │
│  │     │ .example.com       │ example.com         │ ✓ (suffix)   │    │    │
│  │     │ api.example.com    │ www.example.com     │ ✗ (no match) │    │    │
│  │     │ api.example.com    │ api.example.com     │ ✓ (exact)    │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                                                                     │    │
│  │  3. Path matching:                                                  │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ Cookie Path  │ Request Path   │ Match?                  │    │    │
│  │     │──────────────┼────────────────┼─────────────────────────│    │    │
│  │     │ /            │ /api/data      │ ✓ (prefix)              │    │    │
│  │     │ /api         │ /api/data      │ ✓ (prefix)              │    │    │
│  │     │ /api/data    │ /api/data      │ ✓ (exact)               │    │    │
│  │     │ /other       │ /api/data      │ ✗ (no prefix)           │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                                                                     │    │
│  │  4. Security checks:                                                │    │
│  │     • Secure flag: only send over HTTPS                             │    │
│  │     • Expiration: skip expired cookies                              │    │
│  │                                                                     │    │
│  │  5. Build Cookie header:                                            │    │
│  │     Cookie: session=abc123; pref=dark                               │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│  RESPONSE: COOKIE EXTRACTION                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │  Response Headers:                                                  │    │
│  │  Set-Cookie: session=xyz789; Domain=.example.com; Path=/;           │    │
│  │              Secure; HttpOnly; Max-Age=3600; SameSite=Lax           │    │
│  │  Set-Cookie: tracking=disabled; Path=/; Expires=Thu, 01 Jan 2026    │    │
│  │                                                                     │    │
│  │  1. Parse each Set-Cookie header:                                   │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ Set-Cookie: session=xyz789; Domain=.example.com; ...    │    │    │
│  │     │                                                         │    │    │
│  │     │ Split by ";"                                            │    │    │
│  │     │ First part: name=value                                  │    │    │
│  │     │ Rest: attributes                                        │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                                                                     │    │
│  │  2. Parse attributes:                                               │    │
│  │     ┌─────────────────────────────────────────────────────────┐    │    │
│  │     │ Attribute      │ Value           │ Meaning              │    │    │
│  │     │────────────────┼─────────────────┼──────────────────────│    │    │
│  │     │ Domain         │ .example.com    │ Cookie domain        │    │    │
│  │     │ Path           │ /               │ Cookie path          │    │    │
│  │     │ Secure         │ (flag)          │ HTTPS only           │    │    │
│  │     │ HttpOnly       │ (flag)          │ No JS access         │    │    │
│  │     │ Max-Age        │ 3600            │ Lifetime (seconds)   │    │    │
│  │     │ Expires        │ date            │ Expiration time      │    │    │
│  │     │ SameSite       │ Strict/Lax/None │ Cross-site policy    │    │    │
│  │     └─────────────────────────────────────────────────────────┘    │    │
│  │                                                                     │    │
│  │  3. Domain validation:                                              │    │
│  │     • Cookie domain must match request host                         │    │
│  │     • If no Domain attr: use request host (exact match only)        │    │
│  │     • If Domain starts with ".": matches subdomains                 │    │
│  │                                                                     │    │
│  │  4. Store in jar:                                                   │    │
│  │     • Key: domain (lowercased)                                      │    │
│  │     • Update existing cookie if name matches                        │    │
│  │     • Remove if Max-Age=0 or past Expires                           │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## File References

Key source files for each component:

| Component | File | Lines |
|-----------|------|-------|
| Session Creation | `session/session.go` | 69-155 |
| Preset Loading | `fingerprint/presets.go` | 82-247 |
| HTTP/1.1 Transport | `transport/http1_transport.go` | 78-650 |
| HTTP/2 Transport | `transport/http2_transport.go` | 78-550 |
| HTTP/3 Transport | `transport/http3_transport.go` | 182-1000 |
| QUIC Pool | `pool/quic_pool.go` | 24-430 |
| TLS Cache | `transport/tls_cache.go` | - |
| Cookie Jar | `cookies/cookies.go` | - |
| Header Processing | `client/client.go` | 723-1540 |
| LocalProxy | `local_proxy.go` | 1-650 |
| ECH Config | `dns/ech.go` | - |

---

*Generated from httpcloak codebase analysis*
